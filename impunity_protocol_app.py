import streamlit as st
import pandas as pd
import plotly.graph_objects as go
import random
import io

st.set_page_config(page_title="Impunity Protocol Engine", layout="wide")

# -------------------------------
# Sidebar - Patient Profile
# -------------------------------
st.sidebar.title("ðŸ‘¤ Patient Profile")
patient = {
    "ID": "PATIENT_05",
    "Age": 67,
    "Diabetic": True,
    "Allergies": ["Penicillin"],
    "History": "Coma (3 days)"
}
for k, v in patient.items():
    st.sidebar.markdown(f"**{k}:** {v if not isinstance(v, list) else ', '.join(v)}")

st.sidebar.markdown("---")
st.sidebar.markdown("ðŸ”˜ Click below to simulate a real ICU emergency case:")

# -------------------------------
# Simulate input vitals
# -------------------------------
def simulate_vitals(case_id):
    if case_id == 1:
        return {"HR": 82, "SpO2": 96, "Glucose": 61, "Movement": False}
    elif case_id == 2:
        return {"HR": 38, "SpO2": 80, "Glucose": 112, "Movement": False}
    elif case_id == 3:
        return {"HR": 75, "SpO2": 92, "Glucose": 105, "Movement": True}
    else:
        return {}

# -------------------------------
# Generate protocol per case
# -------------------------------
def generate_case_protocol(case_id, vitals):
    if case_id == 1:
        return {
            "title": "CASE 1: Insulin Deficiency",
            "explanation": "Detected low glucose in diabetic patient. Emergency insulin protocol triggered.",
            "topic": "/ICU/devices/patient_05/inject_insulin",
            "actions": [
                "ðŸ’‰ Auto-injection: 6 units insulin",
                "ðŸ“ Update EHR record",
                "ðŸ“¡ Notify remote staff"
            ],
            "critical": True
        }
    elif case_id == 2:
        return {
            "title": "CASE 2: Drug Not Available",
            "explanation": "Low HR + SpOâ‚‚ detected. Required drug unavailable. Auto-request sent to nearby hospitals.",
            "topic": "/ICU/med_alert/adrenaline_request",
            "actions": [
                "â— Adrenaline unavailable locally",
                "ðŸ“¶ Broadcast to hospital network",
                "ðŸš Drone delivery from Hospital_B",
                "ðŸ“² Notify ICU with ETA"
            ],
            "critical": True
        }
    elif case_id == 3:
        return {
            "title": "CASE 3: Patient Awakens",
            "explanation": "Detected movement in previously comatose patient. Awakening alert sent.",
            "topic": "/ICU/alerts/patient_awake",
            "actions": [
                "ðŸ“ˆ Movement pattern matches awakening",
                "ðŸ“¬ ICU team alerted",
                "ðŸ§  Neurological protocol initiated"
            ],
            "critical": True
        }
    else:
        return {
            "title": "Monitoring Mode",
            "explanation": "No emergencies detected. Monitoring ongoing.",
            "topic": "/ICU/monitoring/passive",
            "actions": ["ðŸŸ¢ No emergency", "ðŸ“Š Passive monitoring"],
            "critical": False
        }

# -------------------------------
# Report export
# -------------------------------
def create_report(case_id, vitals, protocol):
    report = f"""ðŸ§¾ ICU Emergency Protocol Report

Patient ID: {patient['ID']}
Age: {patient['Age']}
Case Title: {protocol['title']}

ðŸ“Š Vitals:
- Heart Rate: {vitals['HR']} bpm
- SpOâ‚‚: {vitals['SpO2']}%
- Glucose: {vitals['Glucose']} mg/dL
- Movement Detected: {'Yes' if vitals['Movement'] else 'No'}

ðŸ§  System Decision:
{protocol['explanation']}

ðŸ“¡ MQTT Topic Triggered:
{protocol['topic']}

âœ… Actions Taken:
"""
    for action in protocol['actions']:
        report += f"- {action}\n"

    report += "\nReport generated by Impunity Protocol Simulation Engine."
    return report.encode("utf-8")

# -------------------------------
# Vitals Plotting
# -------------------------------
def plot_vitals(vitals):
    df = pd.DataFrame({
        "Time": [f"T-{i}" for i in range(9, -1, -1)],
        "Heart Rate": [random.randint(70, 100)] * 9 + [vitals["HR"]],
        "SpOâ‚‚": [random.randint(90, 99)] * 9 + [vitals["SpO2"]],
        "Glucose": [random.randint(80, 130)] * 9 + [vitals["Glucose"]],
    })

    fig = go.Figure()
    fig.add_trace(go.Scatter(x=df["Time"], y=df["Heart Rate"], name="Heart Rate", line=dict(color="red")))
    fig.add_trace(go.Scatter(x=df["Time"], y=df["SpOâ‚‚"], name="SpOâ‚‚", line=dict(color="blue")))
    fig.add_trace(go.Scatter(x=df["Time"], y=df["Glucose"], name="Glucose", line=dict(color="green")))
    fig.update_layout(template="plotly_white", height=400)
    return fig

# -------------------------------
# Main Dashboard Actions
# -------------------------------
col1, col2, col3 = st.columns(3)
selected_case = 0

if col1.button("ðŸ©º Case 1: Insulin Deficiency"):
    selected_case = 1
elif col2.button("ðŸ’Š Case 2: Drug Unavailable"):
    selected_case = 2
elif col3.button("ðŸ§  Case 3: Patient Awakens"):
    selected_case = 3

# -------------------------------
# Display Section
# -------------------------------
if selected_case > 0:
    vitals = simulate_vitals(selected_case)
    protocol = generate_case_protocol(selected_case, vitals)

    st.header(protocol["title"])
    st.success(protocol["explanation"])
    st.markdown(f"**ðŸ“¡ MQTT Triggered Topic:** `{protocol['topic']}`")

    st.markdown("### âœ… Actions Taken")
    for a in protocol["actions"]:
        st.markdown(f"- {a}")

    st.markdown("### ðŸ“ˆ Vitals Chart")
    st.plotly_chart(plot_vitals(vitals), use_container_width=True)

    # ðŸ”Š Play alarm if critical
    if protocol["critical"]:
        st.audio("https://assets.mixkit.co/sfx/preview/mixkit-classic-alarm-995.mp3")

    # ðŸ“„ Downloadable report
    st.download_button("ðŸ“„ Download Case Report", data=create_report(selected_case, vitals, protocol),
                       file_name=f"{protocol['title'].replace(' ', '_')}.txt", mime="text/plain")

st.markdown("---")
st.caption("ðŸ“¡ Impunity Protocol Engine | Smart ICU Emergency System Simulation")
